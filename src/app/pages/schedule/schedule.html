<!-- ===============================
     FILTER BAR 
================================ -->
<div class="filter-bar">
  <div nz-row nzGutter="12" nzAlign="middle">

    <!-- GIỚI HẠN CHIỀU RỘNG INPUT -->
    <div nz-col nzSpan="6" class="input-wrapper">
      <input nz-input class="small-input"
             placeholder="Tìm mã HP, tên HP..."
             [(ngModel)]="searchInput"
             [ngModelOptions]="{ standalone: true }">
    </div>

    <div nz-col nzSpan="4" class="right">
      <button nz-button nzType="primary" class="btn-small" (click)="onSearch()">
        Tìm kiếm
      </button>
    </div>
    <div nz-col>
      <button nz-button nzType="primary" class="btn-small" (click)="showAddModal()">Thêm mới</button>
    </div>


  </div>

  <!-- Hàng nút thứ 2 -->
  <div nz-row nzGutter="12" class="right second-row">

    <div nz-col>
      <button nz-button nzType="default" class="btn-small" (click)="showBatchModal()">Tạo đợt thi</button>
    </div>

    <div nz-col>
      <button nz-button nzType="default" class="btn-small" (click)="exportExcel()">Xuất Excel</button>
    </div>

  </div>
</div>

<!-- ===============================
     DANH SÁCH ĐỢT THI
================================ -->
<h3 style="margin-top: 20px;">Danh sách đợt thi</h3>

<nz-tabset [(nzSelectedIndex)]="selectedBatchTabIndex" (nzSelectedIndexChange)="onBatchTabChange($event)">

  <nz-tab *ngFor="let b of examBatches; let i = index" [nzTitle]="b.batchName">

    <!-- Bảng lịch thi từng đợt -->
    <nz-table [nzData]="getSchedulesByBatch(b.batchId)" nzBordered [nzFrontPagination]="false" [nzPageSize]="5"
      nzShowPagination>

      <thead>
        <tr>
          <th>STT</th>
          <th>Mã HP</th>
          <th>Tên HP</th>
          <th>Ngày thi</th>
          <th>Giờ thi</th>
          <th>Số CB</th>
          <th>Ghi chú</th>
          <th>Hành động</th>
        </tr>
      </thead>

      <tbody>
        @for (s of getSchedulesByBatch(b.batchId); let i = $index; track s.id) {
        <tr>
          <td>{{ i + 1 }}</td>
          <td>{{ s.courseCode }}</td>
          <td>{{ s.courseName }}</td>
          <td>{{ s.date }}</td>
          <td>{{ s.examTime }}</td>
          <td>{{ s.proctorsNeeded }}</td>
          <td>{{ s.note }}</td>

          <td>
            <nz-icon nzType="edit" nzTheme="twotone" class="icon-action" (click)="showEditModal(s)">
            </nz-icon>

            <nz-icon nzType="delete" nzTheme="twotone" class="icon-action" (click)="deleteSchedule(s.id)">
            </nz-icon>
          </td>
        </tr>
        }
      </tbody>

    </nz-table>

  </nz-tab>

</nz-tabset>

<!-- ======================================================
     MODAL TẠO / SỬA ĐỢT THI
====================================================== -->
<nz-modal [(nzVisible)]="isBatchVisible" [nzTitle]="isEditingBatch ? 'Cập nhật đợt thi' : 'Tạo đợt thi'"
  (nzOnCancel)="handleBatchCancel()" (nzOnOk)="handleBatchOk()">

  <ng-container *nzModalContent>
    <form nz-form>

      <nz-form-item>
        <nz-form-label nzSpan="6">Tên đợt thi</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input [(ngModel)]="batchForm.batchName" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Ngày bắt đầu</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input type="date" [(ngModel)]="batchForm.startDate" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Ngày kết thúc</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input type="date" [(ngModel)]="batchForm.endDate" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

    </form>
  </ng-container>

</nz-modal>

<!-- ======================================================
     MODAL TẠO / SỬA LỊCH THI
====================================================== -->
<nz-modal [(nzVisible)]="isVisible" [nzTitle]="isEditing ? 'Cập nhật lịch thi' : 'Thêm lịch thi'"
  (nzOnCancel)="handleCancel()" (nzOnOk)="handleOk()">

  <ng-container *nzModalContent>

    <form nz-form>

      <nz-form-item>
        <nz-form-label nzSpan="6">Đợt thi</nz-form-label>
        <nz-form-control nzSpan="16">
          <nz-select nzPlaceHolder="Chọn đợt thi" [(ngModel)]="scheduleForm.batchId"
            [ngModelOptions]="{ standalone: true }">

            <nz-option *ngFor="let b of examBatches" [nzValue]="b.batchId" [nzLabel]="b.batchName">
            </nz-option>

          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Mã HP</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input [(ngModel)]="scheduleForm.courseCode" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Tên HP</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input [(ngModel)]="scheduleForm.courseName" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Ngày thi</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input type="date" [(ngModel)]="scheduleForm.date" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Giờ bắt đầu</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input type="time" [(ngModel)]="scheduleForm.startHour" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Giờ kết thúc</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input type="time" [(ngModel)]="scheduleForm.endHour" [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Số CB</nz-form-label>
        <nz-form-control nzSpan="16">
          <input nz-input type="number" [(ngModel)]="scheduleForm.proctorsNeeded"
            [ngModelOptions]="{ standalone: true }">
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzSpan="6">Ghi chú</nz-form-label>
        <nz-form-control nzSpan="16">
          <textarea nz-input rows="2" [(ngModel)]="scheduleForm.note"
            [ngModelOptions]="{ standalone: true }"></textarea>
        </nz-form-control>
      </nz-form-item>

    </form>

  </ng-container>

</nz-modal>